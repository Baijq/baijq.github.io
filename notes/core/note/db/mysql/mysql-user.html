<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL基础 | BiuBiu</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/note/notebook.png">
    <meta name="description" content="让坚持成为品质，让优秀成为习惯">
    
    <link rel="preload" href="/note/assets/css/0.styles.3ff7832e.css" as="style"><link rel="preload" href="/note/assets/js/app.ef321d21.js" as="script"><link rel="preload" href="/note/assets/js/2.4f793508.js" as="script"><link rel="preload" href="/note/assets/js/31.0d4a248a.js" as="script"><link rel="prefetch" href="/note/assets/js/10.740ddddb.js"><link rel="prefetch" href="/note/assets/js/100.edcdb892.js"><link rel="prefetch" href="/note/assets/js/101.539ca51c.js"><link rel="prefetch" href="/note/assets/js/102.234b6bb4.js"><link rel="prefetch" href="/note/assets/js/103.995ca0da.js"><link rel="prefetch" href="/note/assets/js/104.5fcf95d2.js"><link rel="prefetch" href="/note/assets/js/105.768a22ba.js"><link rel="prefetch" href="/note/assets/js/106.a4297d1b.js"><link rel="prefetch" href="/note/assets/js/107.a05594e3.js"><link rel="prefetch" href="/note/assets/js/108.9a477526.js"><link rel="prefetch" href="/note/assets/js/109.bac52934.js"><link rel="prefetch" href="/note/assets/js/11.bf921344.js"><link rel="prefetch" href="/note/assets/js/110.bdb3407f.js"><link rel="prefetch" href="/note/assets/js/111.5e2be764.js"><link rel="prefetch" href="/note/assets/js/112.5b4a8bb9.js"><link rel="prefetch" href="/note/assets/js/113.f26142bb.js"><link rel="prefetch" href="/note/assets/js/114.330ef2ad.js"><link rel="prefetch" href="/note/assets/js/115.b12c1a7a.js"><link rel="prefetch" href="/note/assets/js/116.bdb6b6cd.js"><link rel="prefetch" href="/note/assets/js/117.f22f3d4e.js"><link rel="prefetch" href="/note/assets/js/118.504536bc.js"><link rel="prefetch" href="/note/assets/js/12.45792551.js"><link rel="prefetch" href="/note/assets/js/13.4ddd53ce.js"><link rel="prefetch" href="/note/assets/js/14.d2dac52c.js"><link rel="prefetch" href="/note/assets/js/15.4c7f4953.js"><link rel="prefetch" href="/note/assets/js/16.252b4803.js"><link rel="prefetch" href="/note/assets/js/17.389df12d.js"><link rel="prefetch" href="/note/assets/js/18.3fb58cd3.js"><link rel="prefetch" href="/note/assets/js/19.fb6bd869.js"><link rel="prefetch" href="/note/assets/js/20.f0e61259.js"><link rel="prefetch" href="/note/assets/js/21.45dc86a3.js"><link rel="prefetch" href="/note/assets/js/22.1f365dfb.js"><link rel="prefetch" href="/note/assets/js/23.5240a888.js"><link rel="prefetch" href="/note/assets/js/24.13926a24.js"><link rel="prefetch" href="/note/assets/js/25.427eede2.js"><link rel="prefetch" href="/note/assets/js/26.83a7e2f1.js"><link rel="prefetch" href="/note/assets/js/27.8e8470ae.js"><link rel="prefetch" href="/note/assets/js/28.4a9d9f18.js"><link rel="prefetch" href="/note/assets/js/29.c4af3eff.js"><link rel="prefetch" href="/note/assets/js/3.65536239.js"><link rel="prefetch" href="/note/assets/js/30.6c65d813.js"><link rel="prefetch" href="/note/assets/js/32.80d3d31c.js"><link rel="prefetch" href="/note/assets/js/33.945ce008.js"><link rel="prefetch" href="/note/assets/js/34.ec311dcf.js"><link rel="prefetch" href="/note/assets/js/35.8131d94a.js"><link rel="prefetch" href="/note/assets/js/36.214f916e.js"><link rel="prefetch" href="/note/assets/js/37.1aae0b4c.js"><link rel="prefetch" href="/note/assets/js/38.e774c833.js"><link rel="prefetch" href="/note/assets/js/39.7a951da8.js"><link rel="prefetch" href="/note/assets/js/4.6506c3de.js"><link rel="prefetch" href="/note/assets/js/40.d754e4e2.js"><link rel="prefetch" href="/note/assets/js/41.ad5491d1.js"><link rel="prefetch" href="/note/assets/js/42.1f9d159f.js"><link rel="prefetch" href="/note/assets/js/43.576eddf0.js"><link rel="prefetch" href="/note/assets/js/44.3daed17c.js"><link rel="prefetch" href="/note/assets/js/45.ab42f39c.js"><link rel="prefetch" href="/note/assets/js/46.c47f3334.js"><link rel="prefetch" href="/note/assets/js/47.ca8cdbc3.js"><link rel="prefetch" href="/note/assets/js/48.0a908190.js"><link rel="prefetch" href="/note/assets/js/49.06cf1714.js"><link rel="prefetch" href="/note/assets/js/5.6f0fa82e.js"><link rel="prefetch" href="/note/assets/js/50.c84ee983.js"><link rel="prefetch" href="/note/assets/js/51.c62bce73.js"><link rel="prefetch" href="/note/assets/js/52.a2ea4776.js"><link rel="prefetch" href="/note/assets/js/53.a2c09fb6.js"><link rel="prefetch" href="/note/assets/js/54.2b7a8916.js"><link rel="prefetch" href="/note/assets/js/55.76013539.js"><link rel="prefetch" href="/note/assets/js/56.3a07a776.js"><link rel="prefetch" href="/note/assets/js/57.4195744c.js"><link rel="prefetch" href="/note/assets/js/58.a345d448.js"><link rel="prefetch" href="/note/assets/js/59.1c5da848.js"><link rel="prefetch" href="/note/assets/js/6.5bff1b90.js"><link rel="prefetch" href="/note/assets/js/60.79ff0b5d.js"><link rel="prefetch" href="/note/assets/js/61.f6613f4e.js"><link rel="prefetch" href="/note/assets/js/62.9701b85b.js"><link rel="prefetch" href="/note/assets/js/63.8a5b760d.js"><link rel="prefetch" href="/note/assets/js/64.0e750038.js"><link rel="prefetch" href="/note/assets/js/65.a654fe7c.js"><link rel="prefetch" href="/note/assets/js/66.1aa49b0d.js"><link rel="prefetch" href="/note/assets/js/67.029d8caa.js"><link rel="prefetch" href="/note/assets/js/68.6d985750.js"><link rel="prefetch" href="/note/assets/js/69.6bd3973e.js"><link rel="prefetch" href="/note/assets/js/7.4b0fb8dd.js"><link rel="prefetch" href="/note/assets/js/70.327e59e2.js"><link rel="prefetch" href="/note/assets/js/71.c5ca4198.js"><link rel="prefetch" href="/note/assets/js/72.8cd323c0.js"><link rel="prefetch" href="/note/assets/js/73.75caf7a3.js"><link rel="prefetch" href="/note/assets/js/74.4ed749de.js"><link rel="prefetch" href="/note/assets/js/75.7dab4512.js"><link rel="prefetch" href="/note/assets/js/76.a13444c0.js"><link rel="prefetch" href="/note/assets/js/77.bf4bee4f.js"><link rel="prefetch" href="/note/assets/js/78.241266c3.js"><link rel="prefetch" href="/note/assets/js/79.8cae2b00.js"><link rel="prefetch" href="/note/assets/js/8.1aba4d1c.js"><link rel="prefetch" href="/note/assets/js/80.2fa30180.js"><link rel="prefetch" href="/note/assets/js/81.1bb32d04.js"><link rel="prefetch" href="/note/assets/js/82.edfc6aaf.js"><link rel="prefetch" href="/note/assets/js/83.16eb78f9.js"><link rel="prefetch" href="/note/assets/js/84.421c7dbe.js"><link rel="prefetch" href="/note/assets/js/85.5bbbca19.js"><link rel="prefetch" href="/note/assets/js/86.394addca.js"><link rel="prefetch" href="/note/assets/js/87.7940eeaf.js"><link rel="prefetch" href="/note/assets/js/88.943fc7f9.js"><link rel="prefetch" href="/note/assets/js/89.98f80472.js"><link rel="prefetch" href="/note/assets/js/9.997d7d86.js"><link rel="prefetch" href="/note/assets/js/90.9c274cc3.js"><link rel="prefetch" href="/note/assets/js/91.a47cab79.js"><link rel="prefetch" href="/note/assets/js/92.0956ae0e.js"><link rel="prefetch" href="/note/assets/js/93.090d4492.js"><link rel="prefetch" href="/note/assets/js/94.5e618411.js"><link rel="prefetch" href="/note/assets/js/95.c178c637.js"><link rel="prefetch" href="/note/assets/js/96.66306725.js"><link rel="prefetch" href="/note/assets/js/97.0af3d82f.js"><link rel="prefetch" href="/note/assets/js/98.882f3311.js"><link rel="prefetch" href="/note/assets/js/99.98d64a35.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.3ff7832e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">BiuBiu</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/note/core/springboot/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/note/core/note/" class="nav-link router-link-active">
  学习笔记
</a></div><div class="nav-item"><a href="/note/core/my/" class="nav-link">
  随心所欲
</a></div><div class="nav-item"><a href="/note/core/about/" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/note/core/springboot/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/note/core/note/" class="nav-link router-link-active">
  学习笔记
</a></div><div class="nav-item"><a href="/note/core/my/" class="nav-link">
  随心所欲
</a></div><div class="nav-item"><a href="/note/core/about/" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/core/note/java/base.html" class="sidebar-link">JAVA 文章集锦</a></li><li><a href="/note/core/note/java/Java8.html" class="sidebar-link">Java8-Lambda</a></li><li><a href="/note/core/note/java/多线程.html" class="sidebar-link">Java多线程</a></li><li><a href="/note/core/note/java/设计模式.html" class="sidebar-link">设计模式</a></li><li><a href="/note/core/note/java/mybatis.html" class="sidebar-link">MyBatis文档</a></li><li><a href="/note/core/note/java/spring-bean生命周期.html" class="sidebar-link">Spring Bean的生命周期</a></li><li><a href="/note/core/note/java/swagger.html" class="sidebar-link">Swager文档</a></li><li><a href="/note/core/note/java/Java开发工具推荐.html" class="sidebar-link">Java 技术栈开发工具推荐</a></li><li><a href="/note/core/note/java/批处理BAT.html" class="sidebar-link">批处理 BAT</a></li><li><a href="/note/core/note/java/RESTFul篇.html" class="sidebar-link">RESTFul API理解</a></li><li><a href="/note/core/note/java/core-java.html" class="sidebar-link">Java核心基础</a></li><li><a href="/note/core/note/java/websocket.html" class="sidebar-link">WebSocket</a></li><li><a href="/note/core/note/java/HTTP协议.html" class="sidebar-link">HTTP协议和网络</a></li><li><a href="/note/core/note/java/pinpoint.html" class="sidebar-link">pinpoint监控工具</a></li><li><a href="/note/core/note/java/遇到得错误.html" class="sidebar-link">工作遇到错误汇总</a></li><li><a href="/note/core/note/java/数据库文档生成工具.html" class="sidebar-link">数据库文档生成工具screw</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/core/note/db/mysql/" aria-current="page" class="sidebar-link">MySQL文章集锦</a></li><li><a href="/note/core/note/db/postgrysql/" class="sidebar-link">PostgreSQL</a></li><li><a href="/note/core/note/db/sqlserver/" class="sidebar-link">SQLServer</a></li><li><a href="/note/core/note/db/oracle/" class="sidebar-link">Oracle</a></li><li><a href="/note/core/note/db/redis/" class="sidebar-link">Redis</a></li><li><a href="/note/core/note/db/elasticsearch/" class="sidebar-link">ElasticSearch</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工具</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/core/note/tool/docker/" class="sidebar-link">Docker-虚拟化容器技术</a></li><li><a href="/note/core/note/tool/linux/" class="sidebar-link">Linux Centos7</a></li><li><a href="/note/core/note/tool/maven/" class="sidebar-link">Maven-项目管理工具</a></li><li><a href="/note/core/note/tool/nginx/" class="sidebar-link">Nginx-高性能服务器</a></li><li><a href="/note/core/note/tool/curl/" class="sidebar-link">curl简单使用</a></li><li><a href="/note/core/note/tool/tomcat/" class="sidebar-link">Tomcat-服务器</a></li><li><a href="/note/core/note/tool/git/" class="sidebar-link">GIT-版本控制工具</a></li><li><a href="/note/core/note/tool/chrome/" class="sidebar-link">JsonView-Chrome插件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Python</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/core/note/python/" class="sidebar-link">Python</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/core/note/web/请求API接口.html" class="sidebar-link">Ajax 请求API接口</a></li><li><a href="/note/core/note/web/vue.html" class="sidebar-link">vue</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql基础"><a href="#mysql基础" class="header-anchor">#</a> MySQL基础</h1> <h2 id="一、存储引擎"><a href="#一、存储引擎" class="header-anchor">#</a> 一、存储引擎</h2> <p>MySQL 5.5 之前，MyISAM是默认存储引擎，5.5 版本之后，引入了 InnoDB（事务性数据库引擎）</p> <table><thead><tr><th>项目</th> <th>MyISAM</th> <th>InnoDB</th></tr></thead> <tbody><tr><td>是否支持行级锁</td> <td>只有表级锁</td> <td>支持行级锁和表级锁（默认为行级锁）</td></tr> <tr><td>是否支持事务</td> <td>不支持</td> <td>InnoDB 支持</td></tr> <tr><td>是否支持数据库异常崩溃后的安全恢复</td> <td>不支持</td> <td>支持（依赖于 redo log）</td></tr> <tr><td>是否支持 MVCC</td> <td>不支持</td> <td>支持</td></tr></tbody></table> <blockquote><p>备注：</p> <p>InnoDB 引擎使用 redo log(重做日志) 保证事务的持久性，使用 undo log(回滚日志) 来保证事务的原子性<br>
InnoDB 引擎通过 锁机制、MVCC 等手段来保证事务的隔离性，默认隔离级别 REPEATABLE-READ<br>
MVCC 可以看作是行级锁的一个升级，可以有效减少加锁操作，提供性能</p></blockquote> <h2 id="二、事务"><a href="#二、事务" class="header-anchor">#</a> 二、事务</h2> <ol><li><p>概念：事务是逻辑上的一组操作，要么都执行，要么都不执行。</p></li> <li><p>流程：</p></li></ol> <ul><li><p>事务开启<code>START TRANSACTION; 或者 BEGIN;</code>开启事务后，所有被执行的SQL语句均被认作当前事务内的SQL语句。</p></li> <li><p>事务提交<code>COMMIT;</code></p></li> <li><p>事务回滚<code>ROLLBACK;</code>如果部分操作发生问题，映射到事务开启前。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 开启一个事务</span>
START TRANSACTION<span class="token punctuation">;</span>
<span class="token comment"># 多条 SQL 语句</span>
UPDATE t_user SET <span class="token assign-left variable">phone</span><span class="token operator">=</span><span class="token string">'15365657896'</span> WHERE <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">10001</span><span class="token punctuation">;</span>
<span class="token comment">## 提交事务</span>
COMMIT<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul> <ol start="3"><li><p>ACID特性：</p> <p>☑️<strong>原子性</strong>：事务是最小的执行单位，不允许分割。事务的原子性确保动作要么全部完成，要么完全不起作用；<br>
☑️<strong>一致性</strong>：执行事务前后，数据保持一致，例如转账业务中，无论事务是否成功，转账者和收款人的总额应该是不变的；<br>
☑️<strong>隔离性</strong>：并发访问数据库时，一个用户的事务不被其他事务所干扰，各并发事务之间数据库是独立的；<br>
☑️<strong>持久性</strong>：一个事务被提交之后。它对数据库中数据的改变是持久的，即使数据库发生故障也不应该对其有任何影响。</p></li> <li><p>并发事务带来的问题</p> <p>☑️<strong>脏读</strong>：当一个事务正在访问数据并且对数据进行了修改，而这种修改还没有提交到数据库中，这时另外一个事务也访问了这个数据，然后使用了这个数据。因为这个数据是还没有提交的数据，那么另外一个事务读到的这个数据是“脏数据”    <br>
☑️<strong>不可重复读</strong>： 指在一个事务内多次读同一数据。在这个事务还没有结束时，另一个事务也访问该数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改导致第一个事务两次读取的数据可能不太一样。这就发生了在一个事务内两次读到的数据是不一样的情况，因此称为不可重复读。   <br><br>
☑️<strong>幻读</strong>：幻读与不可重复读类似。它发生在一个事务（T1）读取了几行数据，接着另一个并发事务（T2）插入了一些数据时。在随后的查询中，第一个事务（T1）就会发现多了一些原本不存在的记录，就好像发生了幻觉一样，所以称为幻读。     <br></p> <blockquote><p>不可重复读和幻读区别：不可重复读的重点是修改比如多次读取一条记录发现其中某些列的值被修改，幻读的重点在于新增或者删除比如多次读取一条记录发现记录增多或减少了</p></blockquote></li> <li><p>隔离级别
☑️<strong>读未提交</strong> READ-UNCOMMITTED：可能会导致脏读、幻读或不可重复读。     <br>
☑️<strong>读已提交</strong> READ-COMMITTED：可以阻止脏读，但是幻读或不可重复读仍有可能发生。    <br>
☑️<strong>可重复读</strong> REPEATABLE-READ：可以阻止脏读和不可重复读，但幻读仍有可能发生。    <br>
☑️<strong>可串行化</strong> SERIALIZABLE：该级别可以防止脏读、不可重复读以及幻读。    <br></p> <table><thead><tr><th></th> <th>脏读</th> <th>不可重复读</th> <th>幻读</th> <th>备注</th></tr></thead> <tbody><tr><td>读未提交</td> <td>❌</td> <td>❌</td> <td>❌</td> <td></td></tr> <tr><td>读已提交</td> <td>✔️</td> <td>❌</td> <td>❌</td> <td></td></tr> <tr><td>可重复读</td> <td>✔️</td> <td>✔️</td> <td>❌</td> <td>gap锁，MySQL默认级别</td></tr> <tr><td>串行化</td> <td>✔️</td> <td>✔️</td> <td>✔️</td> <td>读锁</td></tr></tbody></table> <p>查询MySQL(8.0)的默认隔离级别<code>SELECT @@transaction_isolation;</code></p> <p>注意：在使用分布式事务时，InnoDB 存储引擎的事务隔离级别必须设置为 SERIALIZABLE。</p></li></ol> <h2 id="三、索引"><a href="#三、索引" class="header-anchor">#</a> 三、索引</h2> <p>MySQL索引的类型有 BTree索引，哈希索引，全文索引</p> <p>InnoDB存储引擎中有页的概念，默认每个页的大小为 16KB <code>show variables like 'innodb_page_size';</code></p> <p>InnoDB 存储引擎就是用 B+Tree 实现其索引结构。</p> <p>索引大大减少了 MySQL 服务器需要扫描的数据量。(全表扫描)</p> <p>索引可以帮助 MySQL 服务器避免排序和临时表。</p> <p>索引可以将随机 I/O 变为顺序 I/O。</p> <h3 id="_1、操作索引"><a href="#_1、操作索引" class="header-anchor">#</a> 1、操作索引</h3> <ol><li><p>添加 PRIMARY KEY（主键索引）</p> <blockquote><p>ALTER TABLE <code>table_name</code> ADD PRIMARY KEY ( <code>column</code> )</p></blockquote></li> <li><p>添加 UNIQUE(唯一索引)</p> <blockquote><p>ALTER TABLE <code>table_name</code> ADD UNIQUE ( <code>column</code> )</p></blockquote></li> <li><p>添加 INDEX(普通索引)</p> <blockquote><p>ALTER TABLE <code>table_name</code> ADD INDEX index_name ( <code>column</code> )</p></blockquote></li> <li><p>添加 FULLTEXT(全文索引)</p> <blockquote><p>ALTER TABLE <code>table_name</code> ADD FULLTEXT ( <code>column</code>)</p></blockquote></li> <li><p>添加多列索引</p> <blockquote><p>ALTER TABLE <code>table_name</code> ADD INDEX index_name ( <code>column1</code>, <code>column2</code>, <code>column3</code> )</p></blockquote></li> <li><p>重建索引，在常规的数据库维护操作中经常使用，实质上的对表的修复。</p> <blockquote><p>repair table index_test quick;</p></blockquote></li> <li><p>查询索引</p> <blockquote><p>show index from|in table_name</p></blockquote></li> <li><p>删除索引</p> <blockquote><p>DROP INDEX idx on <code>table_name</code>;</p></blockquote></li></ol> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token keyword">UNIQUE</span><span class="token operator">/</span>FULLTEXT<span class="token punctuation">]</span> <span class="token keyword">INDEX</span> <span class="token operator">&lt;</span>索引名<span class="token operator">&gt;</span> <span class="token keyword">ON</span> <span class="token operator">&lt;</span>表名<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>列名<span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token operator">&lt;</span>表名<span class="token operator">&gt;</span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span><span class="token operator">|</span><span class="token keyword">UNIQUE</span><span class="token operator">|</span><span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token operator">|</span>FULLTEXT <span class="token operator">&lt;</span>索引名<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>列名<span class="token operator">&gt;</span><span class="token punctuation">)</span>

<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> <span class="token operator">&lt;</span>索引名<span class="token operator">&gt;</span> <span class="token keyword">ON</span> <span class="token operator">&lt;</span>表名<span class="token operator">&gt;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token operator">&lt;</span>表名<span class="token operator">&gt;</span> <span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> <span class="token operator">&lt;</span>索引名<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="四、日志"><a href="#四、日志" class="header-anchor">#</a> 四、日志</h2> <p>MySQL日志有很多种，比较重要的有二进制日志binlog（归档日志）和事务日志redo log（重做日志）和 undo log（回滚日志）</p> <ul><li><p><strong>binlog</strong> MySQL服务器层实现</p></li> <li><p><strong>redo log</strong> InnoDB引擎实现</p></li> <li><p><strong>undo log</strong> InnoDB引擎实现</p></li></ul> <p>MySQL InnoDB 引擎使用 redo log(重做日志) 保证事务的持久性，使用 undo log(回滚日志) 来保证事务的原子性。<br>
MySQL数据库的数据备份、主备、主主、主从都离不开binlog，需要依靠binlog来同步数据，保证数据一致性。</p> <p>✔️<a href="/note/core/note/db/mysql/base/mysql-deletefrom.html">MySQL误操作delete from...的后续，使用binlog恢复数据</a></p> <h2 id="五、json类型"><a href="#五、json类型" class="header-anchor">#</a> 五、JSON类型</h2> <blockquote><p>JSON 类型是 MySQL 5.7 版本新增的数据类型，用好 JSON 数据类型可以有效解决很多业务中实际问题。</p></blockquote> <ul><li>推荐用 MySQL 8.0.17 以上的版本，性能更好</li> <li>不要将有明显关系型的数据用 JSON 存储</li> <li>JSON 数据类型推荐使用在不经常更新的静态数据</li></ul> <h3 id="用户登录示例"><a href="#用户登录示例" class="header-anchor">#</a> 用户登录示例</h3> <ol><li><p>新建一个表，测试JSON类型</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> user_login<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_login<span class="token punctuation">(</span>
	user_id <span class="token keyword">BIGINT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	login_info JSON<span class="token punctuation">,</span>
	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>插入测试数据</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> <span class="token variable">@a</span> <span class="token operator">=</span> <span class="token string">'
{
   &quot;cellphone&quot; : &quot;13918888888&quot;,
   &quot;wxchat&quot; : &quot;破产码农&quot;,
   &quot;QQ&quot; : &quot;82946772&quot;
}
'</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user_login <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">@a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SET</span> <span class="token variable">@b</span> <span class="token operator">=</span> <span class="token string">'
{
	&quot;cellphone&quot; : &quot;15026888888&quot;
}
'</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user_login <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token variable">@b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li> <li><p>查询数据</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> 
	JSON_UNQUOTE<span class="token punctuation">(</span>JSON_EXTRACT<span class="token punctuation">(</span>login_info<span class="token punctuation">,</span> <span class="token string">&quot;$.cellphone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cellphone<span class="token punctuation">,</span>
	JSON_UNQUOTE<span class="token punctuation">(</span>JSON_EXTRACT<span class="token punctuation">(</span>login_info<span class="token punctuation">,</span> <span class="token string">&quot;$.wxchat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> wxchat<span class="token punctuation">,</span>
	JSON_UNQUOTE<span class="token punctuation">(</span>JSON_EXTRACT<span class="token punctuation">(</span>login_info<span class="token punctuation">,</span> <span class="token string">&quot;$.QQ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> qq
<span class="token keyword">FROM</span> user_login<span class="token punctuation">;</span>
<span class="token comment">-- 每次写 JSON_EXTRACT、JSON_UNQUOTE 非常麻烦，MySQL 还提供了 -&gt;&gt; 表达式</span>
<span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> 
	login_info<span class="token operator">-</span><span class="token operator">&gt;&gt;</span><span class="token string">&quot;$.cellphone&quot;</span> cellphone<span class="token punctuation">,</span>
	login_info<span class="token operator">-</span><span class="token operator">&gt;&gt;</span><span class="token string">&quot;$.wxchat&quot;</span> wxchat<span class="token punctuation">,</span>
	login_info<span class="token operator">-</span><span class="token operator">&gt;&gt;</span><span class="token string">&quot;$.QQ&quot;</span> qq
<span class="token keyword">FROM</span> user_login<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>json数据量大时，建立索引</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> user_login <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> cellphone <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">(</span>login_info<span class="token operator">-</span><span class="token operator">&gt;&gt;</span><span class="token string">&quot;$.cellphone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> user_login <span class="token keyword">ADD</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> idx_cellphone<span class="token punctuation">(</span>cellphone<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>上述 SQL 首先创建了一个虚拟列 cellphone，这个列是由函数 loginInfo-&gt;&gt;&quot;$.cellphone&quot; 计算得到的。然后在这个虚拟列上创建一个唯一索引 idx_cellphone。这时再通过虚拟列 cellphone 进行查询，就可以看到优化器会使用到新创建的 idx_cellphone 索引</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user_login <span class="token keyword">WHERE</span> cellphone <span class="token operator">=</span> <span class="token string">'13918888888'</span>\G
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>\G</code>:将查询到的横向表格纵向输出，方便阅读</p> <p><img src="https://s4.ax1x.com/2022/02/11/HUaay4.png" alt="HUaay4.png"></p> <p>我们可以在一开始创建表的时候，就完成虚拟列及函数索引的创建。如下表创建的列 cellphone 对应的就是 JSON 中的内容，是个虚拟列；uk_idx_cellphone 就是在虚拟列 cellphone 上所创建的索引</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_login <span class="token punctuation">(</span>
	user_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
	login_info JSON<span class="token punctuation">,</span>
	cellphone <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">(</span>login_info<span class="token operator">-</span><span class="token operator">&gt;&gt;</span><span class="token string">&quot;$.cellphone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> uk_idx_cellphone<span class="token punctuation">(</span>cellphone<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ol> <h3 id="用户画像示例"><a href="#用户画像示例" class="header-anchor">#</a> 用户画像示例</h3> <ol><li><p>创建表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> Tags <span class="token punctuation">(</span>
	tagId <span class="token keyword">bigint</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
	tagName <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>tagId<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>查询标签</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Tags<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+--------------+</span>
<span class="token operator">|</span> tagId <span class="token operator">|</span> tagName      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+--------------+</span>
<span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">70</span>后         <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">80</span>后         <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">3</span> <span class="token operator">|</span> <span class="token number">90</span>后         <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">00</span>后         <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">5</span> <span class="token operator">|</span> 爱运动       <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">6</span> <span class="token operator">|</span> 高学历       <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">7</span> <span class="token operator">|</span> 小资         <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">8</span> <span class="token operator">|</span> 有房         <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">9</span> <span class="token operator">|</span> 有车         <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">10</span> <span class="token operator">|</span> 常看电影     <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">11</span> <span class="token operator">|</span> 爱网购       <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">12</span> <span class="token operator">|</span> 爱外卖       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+--------------+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li> <li><p>若不用 JSON 数据类型进行标签存储，通常会将用户标签通过字符串，加上分割符的方式，在一个字段中存取用户所有的标签：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token operator">+</span><span class="token comment">-------+---------------------------------------+</span>
<span class="token operator">|</span>用户    <span class="token operator">|</span>标签                                   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+---------------------------------------+</span>
<span class="token operator">|</span>David  <span class="token operator">|</span><span class="token number">80</span>后 ； 高学历 ； 小资 ； 有房 ；常看电影   <span class="token operator">|</span>
<span class="token operator">|</span>Tom    <span class="token operator">|</span><span class="token number">90</span>后 ；常看电影 ； 爱外卖                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+---------------------------------------</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>这样做的缺点是：不好搜索特定画像的用户，另外分隔符也是一种自我约定，在数据库中其实可以任意存储其他数据，最终产生脏数据。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> UserTag<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> UserTag <span class="token punctuation">(</span>
	userId <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	userTags JSON<span class="token punctuation">,</span>
	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> UserTag <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'[2,6,8,10]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> UserTag <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'[3,10,12]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>MySQL 8.0.17 版本开始支持 Multi-Valued Indexes，用于在 JSON 数组上创建索引，并通过函数 member of、json_contains、json_overlaps 来快速检索索引数据。所以你可以在表 UserTag 上创建 Multi-Valued Indexes：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> UserTag
<span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> idx_user_tags <span class="token punctuation">(</span><span class="token punctuation">(</span>cast<span class="token punctuation">(</span><span class="token punctuation">(</span>userTags<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">unsigned</span> array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>如果想要查询用户画像为常看电影的用户，可以使用函数 MEMBER OF：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> UserTag 
<span class="token keyword">WHERE</span> <span class="token number">10</span> MEMBER <span class="token keyword">OF</span><span class="token punctuation">(</span>userTags<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span>\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
		   id: <span class="token number">1</span>
  select_type: <span class="token keyword">SIMPLE</span>
		<span class="token keyword">table</span>: UserTag
   partitions: <span class="token boolean">NULL</span>
		 <span class="token keyword">type</span>: ref
possible_keys: idx_user_tags
		  <span class="token keyword">key</span>: idx_user_tags
	  key_len: <span class="token number">9</span>
		  ref: const
		 <span class="token keyword">rows</span>: <span class="token number">1</span>
	 filtered: <span class="token number">100.00</span>
		Extra: <span class="token keyword">Using</span> <span class="token keyword">where</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> UserTag 
<span class="token keyword">WHERE</span> <span class="token number">10</span> MEMBER <span class="token keyword">OF</span><span class="token punctuation">(</span>userTags<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+---------------+</span>
<span class="token operator">|</span> userId <span class="token operator">|</span> userTags      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+---------------+</span>
<span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">|</span>
<span class="token operator">|</span>      <span class="token number">2</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+---------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></li> <li><p>如果想要查询画像为 80 后，且常看电影的用户，可以使用函数 JSON_CONTAINS：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> UserTag 
<span class="token keyword">WHERE</span> JSON_CONTAINS<span class="token punctuation">(</span>userTags<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">,</span> <span class="token string">'[2,10]'</span><span class="token punctuation">)</span>\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
		   id: <span class="token number">1</span>
  select_type: <span class="token keyword">SIMPLE</span>
		<span class="token keyword">table</span>: UserTag
   partitions: <span class="token boolean">NULL</span>
		 <span class="token keyword">type</span>: range
possible_keys: idx_user_tags
		  <span class="token keyword">key</span>: idx_user_tags
	  key_len: <span class="token number">9</span>
		  ref: <span class="token boolean">NULL</span>
		 <span class="token keyword">rows</span>: <span class="token number">3</span>
	 filtered: <span class="token number">100.00</span>
		Extra: <span class="token keyword">Using</span> <span class="token keyword">where</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> UserTag 
<span class="token keyword">WHERE</span> JSON_CONTAINS<span class="token punctuation">(</span>userTags<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">,</span> <span class="token string">'[2,10]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+---------------+</span>
<span class="token operator">|</span> userId <span class="token operator">|</span> userTags      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+---------------+</span>
<span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+---------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div></li> <li><p>如果想要查询画像为 80 后、90 后，且常看电影的用户，则可以使用函数 JSON_OVERLAP：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> UserTag 
<span class="token keyword">WHERE</span> JSON_OVERLAPS<span class="token punctuation">(</span>userTags<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">,</span> <span class="token string">'[2,3,10]'</span><span class="token punctuation">)</span>\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
		   id: <span class="token number">1</span>
  select_type: <span class="token keyword">SIMPLE</span>
		<span class="token keyword">table</span>: UserTag
   partitions: <span class="token boolean">NULL</span>
		 <span class="token keyword">type</span>: range
possible_keys: idx_user_tags
		  <span class="token keyword">key</span>: idx_user_tags
	  key_len: <span class="token number">9</span>
		  ref: <span class="token boolean">NULL</span>
		 <span class="token keyword">rows</span>: <span class="token number">4</span>
	 filtered: <span class="token number">100.00</span>
		Extra: <span class="token keyword">Using</span> <span class="token keyword">where</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> UserTag 
<span class="token keyword">WHERE</span> JSON_OVERLAPS<span class="token punctuation">(</span>userTags<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">,</span> <span class="token string">'[2,3,10]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------+---------------+</span>
<span class="token operator">|</span> userId <span class="token operator">|</span> userTags      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+---------------+</span>
<span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">|</span>
<span class="token operator">|</span>      <span class="token number">2</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+---------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></li></ol> <h2 id="六、高级语法"><a href="#六、高级语法" class="header-anchor">#</a> 六、高级语法</h2> <h3 id="_1-case-when"><a href="#_1-case-when" class="header-anchor">#</a> 1.case when</h3> <p>如图，我们想实现这个数据查询，怎么做？
<img src="https://s1.ax1x.com/2022/05/08/O3E0F1.png" alt="O3E0F1.png"></p> <p>解决思路，<code>CASE WHEN</code> 实现</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_stu_cause<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> 姓名<span class="token punctuation">,</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> 课程 <span class="token operator">=</span> <span class="token string">'语文'</span> <span class="token keyword">THEN</span> 分数 <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">'语文'</span><span class="token punctuation">,</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> 课程 <span class="token operator">=</span> <span class="token string">'数学'</span>	<span class="token keyword">THEN</span> 分数 <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">'数学'</span>
<span class="token keyword">FROM</span> tb_stu_cause<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> 姓名<span class="token punctuation">,</span>
<span class="token function">MAX</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> 课程 <span class="token operator">=</span> <span class="token string">'语文'</span> <span class="token keyword">THEN</span> 分数 <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'语文'</span><span class="token punctuation">,</span>
<span class="token function">MAX</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> 课程 <span class="token operator">=</span> <span class="token string">'数学'</span> <span class="token keyword">THEN</span> 分数 <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'数学'</span>
<span class="token keyword">FROM</span> tb_stu_cause
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 姓名<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="https://s1.ax1x.com/2022/05/08/O3EBJx.png" alt="O3EBJx.png"></p> <h3 id="_2-load-data"><a href="#_2-load-data" class="header-anchor">#</a> 2.load data</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">use</span> base<span class="token punctuation">;</span>
<span class="token comment">#查看是否开启加载本地文件</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'local_infile'</span><span class="token punctuation">;</span>
<span class="token comment">#开启全局本地文件设置</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> local_infile<span class="token operator">=</span><span class="token keyword">on</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> <span class="token keyword">infile</span> <span class="token string">'./t_user.txt'</span>
<span class="token keyword">into</span> <span class="token keyword">table</span> base<span class="token punctuation">.</span>t_user 
<span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span>
<span class="token keyword">lines</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span>
<span class="token keyword">ignore</span> <span class="token number">1</span> <span class="token keyword">lines</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> base<span class="token punctuation">.</span>t_user<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_3-常用函数"><a href="#_3-常用函数" class="header-anchor">#</a> 3.常用函数</h3> <ol><li><p>聚合函数</p> <p>count sum avg max min</p></li> <li><p>数学函数</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> 
 abs<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> 									<span class="token keyword">AS</span> <span class="token string">'绝对值'</span> 
<span class="token punctuation">,</span>bin<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> 									<span class="token keyword">AS</span> <span class="token string">'二进制'</span>
<span class="token punctuation">,</span>oct<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> 									<span class="token keyword">AS</span> <span class="token string">'八进制'</span>
<span class="token punctuation">,</span>hex<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> 									<span class="token keyword">AS</span> <span class="token string">'十六进制'</span>
<span class="token punctuation">,</span>pi<span class="token punctuation">(</span><span class="token punctuation">)</span> 										<span class="token keyword">AS</span> <span class="token string">'圆周率'</span>
<span class="token punctuation">,</span>ceil<span class="token punctuation">(</span><span class="token number">5.5</span><span class="token punctuation">)</span> 									<span class="token keyword">AS</span> <span class="token string">'大于x的最小整数值'</span>
<span class="token punctuation">,</span>floor<span class="token punctuation">(</span><span class="token number">5.5</span><span class="token punctuation">)</span> 								<span class="token keyword">AS</span> <span class="token string">'小于x的最大整数值'</span>
<span class="token punctuation">,</span>greatest<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">)</span> 						<span class="token keyword">AS</span> <span class="token string">'集合中最大的值'</span>
<span class="token punctuation">,</span>least<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">)</span> 						<span class="token keyword">AS</span> <span class="token string">'集合中最小的值'</span>
<span class="token punctuation">,</span><span class="token function">mod</span><span class="token punctuation">(</span><span class="token number">1023</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> 								<span class="token keyword">AS</span> <span class="token string">'余数'</span>
<span class="token punctuation">,</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span> 									<span class="token keyword">AS</span> <span class="token string">'返回0-1内的随机值'</span>
<span class="token punctuation">,</span>rand<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>  									<span class="token keyword">AS</span> <span class="token string">'提供一个参数生成一个指定值'</span>
<span class="token punctuation">,</span>rand<span class="token punctuation">(</span><span class="token string">'test123'</span><span class="token punctuation">)</span>  							<span class="token keyword">AS</span> <span class="token string">'提供一个参数生成一个指定值'</span>
<span class="token punctuation">,</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">1023.1023</span><span class="token punctuation">)</span> 							<span class="token keyword">AS</span> <span class="token string">'四舍五入'</span>
<span class="token punctuation">,</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">1023.1023</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> 						<span class="token keyword">AS</span> <span class="token string">'四舍五入,保留n位小数'</span>
<span class="token punctuation">,</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">1023.1023</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  						<span class="token keyword">AS</span> <span class="token string">'四舍五入整数位'</span>
<span class="token punctuation">,</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">1025.1025</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  						<span class="token keyword">AS</span> <span class="token string">'四舍五入整数位'</span>
<span class="token punctuation">,</span><span class="token keyword">truncate</span><span class="token punctuation">(</span><span class="token number">1023.1023</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> 					<span class="token keyword">AS</span> <span class="token string">'截断为n位小数'</span>
<span class="token punctuation">,</span><span class="token keyword">truncate</span><span class="token punctuation">(</span><span class="token number">1023.1023</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  					<span class="token keyword">AS</span> <span class="token string">'截断为整数位'</span>
<span class="token punctuation">,</span><span class="token keyword">truncate</span><span class="token punctuation">(</span><span class="token number">1025.1025</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 					<span class="token keyword">AS</span> <span class="token string">'截断为整数位'</span>
<span class="token punctuation">,</span>sign<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span> 									<span class="token keyword">AS</span> <span class="token string">'-1表示负数'</span>
<span class="token punctuation">,</span>sign<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 									<span class="token keyword">AS</span> <span class="token string">'0 表示零'</span>
<span class="token punctuation">,</span>sign<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> 									<span class="token keyword">AS</span> <span class="token string">'1 表示正数'</span>
<span class="token punctuation">,</span>sqrt<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> 									<span class="token keyword">AS</span> <span class="token string">'平方根'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div></li> <li><p>字符串函数</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 连接字符串 'fx67ll'</span>
<span class="token keyword">SELECT</span> concat<span class="token punctuation">(</span><span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'67'</span><span class="token punctuation">,</span> <span class="token string">'ll'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 用分隔符连接字符串 'fx67ll'，注意如果分隔符为NULL，则结果为NULL</span>
<span class="token keyword">SELECT</span> concat_ws<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'fx'</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># fx-6-7-l-l</span>
<span class="token keyword">SELECT</span> concat_ws<span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'fx'</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># NULL</span>

<span class="token comment"># 将字符串 'fx67ll' 从3位置开始的2个字符替换为 '78'</span>
<span class="token keyword">SELECT</span> <span class="token keyword">insert</span><span class="token punctuation">(</span><span class="token string">'fx67ll'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'78'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># fx78ll</span>

<span class="token comment"># 返回字符串 'fx67ll' 左边的3个字符：fx6</span>
<span class="token keyword">SELECT</span> <span class="token keyword">left</span><span class="token punctuation">(</span><span class="token string">'fx67ll'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 返回字符串 'fx67ll' 右边的4个字符: 67ll</span>
<span class="token keyword">SELECT</span> <span class="token keyword">right</span><span class="token punctuation">(</span><span class="token string">'fx67ll'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 返回字符串 'fx67ll' 第3个字符之后的子字符串：67ll</span>
<span class="token keyword">SELECT</span> substring<span class="token punctuation">(</span><span class="token string">'fx67ll'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 返回字符串 'fx67ll' 倒数第3个字符之后的子字符串：7ll</span>
<span class="token keyword">SELECT</span> substring<span class="token punctuation">(</span><span class="token string">'fx67ll'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 返回字符串 'fx67ll' 第3个字符之后的2个字符：67</span>
<span class="token keyword">SELECT</span> substring<span class="token punctuation">(</span><span class="token string">'fx67ll'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 切割字符串 ' fx67ll ' 两边的空字符，注意字符串左右有空格：'fx67ll'</span>
<span class="token keyword">SELECT</span> trim<span class="token punctuation">(</span><span class="token string">' fx67ll '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 切割字符串 ' fx67ll ' 左边的空字符：'fx67ll '</span>
<span class="token keyword">SELECT</span> ltrim<span class="token punctuation">(</span><span class="token string">' fx67ll '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 切割字符串 ' fx67ll ' 右边的字符串：' fx67ll'</span>
<span class="token keyword">SELECT</span> rtrim<span class="token punctuation">(</span><span class="token string">' fx67ll '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 重复字符 'fx67ll' 三次：fx67llfx67llfx67ll</span>
<span class="token keyword">SELECT</span> <span class="token keyword">repeat</span><span class="token punctuation">(</span><span class="token string">'fx67ll'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 对字符串 'fx67ll' 进行反向排序：ll76xf</span>
<span class="token keyword">SELECT</span> reverse<span class="token punctuation">(</span><span class="token string">'fx67ll'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 返回字符串的长度：6</span>
<span class="token keyword">SELECT</span> length<span class="token punctuation">(</span><span class="token string">'fx67ll'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 对字符串进行大小写处理，大小写各两种方式</span>
<span class="token keyword">SELECT</span> upper<span class="token punctuation">(</span><span class="token string">'FX67ll'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># FX67LL</span>
<span class="token keyword">SELECT</span> lower<span class="token punctuation">(</span><span class="token string">'fx67LL'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># fx67ll</span>
<span class="token keyword">SELECT</span> <span class="token function">ucase</span><span class="token punctuation">(</span><span class="token string">'fX67Ll'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># FX67LL</span>
<span class="token keyword">SELECT</span> <span class="token function">lcase</span><span class="token punctuation">(</span><span class="token string">'Fx67lL'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># fx67ll</span>

<span class="token comment"># 返回 'f' 在 'fx67ll' 中的第一个位置：1</span>
<span class="token keyword">SELECT</span> position<span class="token punctuation">(</span><span class="token string">'f'</span> <span class="token operator">IN</span> <span class="token string">'fx67ll'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 返回 '1' 在 'fx67ll' 中的第一个位置，不存在返回0：0</span>
<span class="token keyword">SELECT</span> position<span class="token punctuation">(</span><span class="token string">'1'</span> <span class="token operator">IN</span> <span class="token string">'fx67ll'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 比较字符串，第一个参数小于第二个返回负数，否则返回正数，相等返回0</span>
<span class="token keyword">SELECT</span> strcmp<span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> <span class="token string">'abd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># -1</span>
<span class="token keyword">SELECT</span> strcmp<span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> <span class="token string">'abb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># 1</span>
<span class="token keyword">SELECT</span> strcmp<span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># 0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div></li> <li><p>时间函数</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 返回当前日期，时间，日期时间</span>
<span class="token keyword">SELECT</span> <span class="token keyword">current_date</span><span class="token punctuation">,</span> <span class="token keyword">current_time</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 返回当前时间的时，分，秒</span>
<span class="token keyword">SELECT</span> <span class="token keyword">hour</span><span class="token punctuation">(</span><span class="token keyword">current_time</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">minute</span><span class="token punctuation">(</span><span class="token keyword">current_time</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">second</span><span class="token punctuation">(</span><span class="token keyword">current_time</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 返回当前日期的年，月，日</span>
<span class="token keyword">SELECT</span> <span class="token keyword">year</span><span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">month</span><span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">day</span><span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 返回当前日期的季度</span>
<span class="token keyword">SELECT</span> quarter<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 返回当前月份的名称，当前星期的名称</span>
<span class="token keyword">SELECT</span> monthname<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dayname<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 返回当前日在星期的天数，当前日在月的天数，当前日在年的天数</span>
<span class="token keyword">SELECT</span> dayofweek<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dayofmonth<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dayofyear<span class="token punctuation">(</span><span class="token keyword">current_date</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 最近7天</span>
<span class="token keyword">SELECT</span> create_time <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> DATE_SUB<span class="token punctuation">(</span>CURDATE<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token number">6</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token keyword">DATE</span><span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li> <li><p>控制流函数</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># IF判断：1</span>
<span class="token keyword">SELECT</span> <span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>  <span class="token comment"># 1</span>

<span class="token comment"># IFNULL判断</span>
<span class="token comment"># 判断第一个表达式是否为NULL，如果为NULL则返回第二个参数的值，否则返回第一个参数的值</span>
<span class="token keyword">SELECT</span> IFNULL<span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># 1</span>
<span class="token keyword">SELECT</span> IFNULL<span class="token punctuation">(</span><span class="token string">'fx67ll'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># fx67ll</span>

<span class="token comment"># ISNULL判断</span>
<span class="token comment"># 接受1个参数，并测试该参数是否为NULL，如果参数为NULL，则返回1，否则返回0</span>
<span class="token keyword">SELECT</span> ISNULL<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># 0</span>
<span class="token keyword">SELECT</span> ISNULL<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># 1</span>

<span class="token comment"># NULLIF判断</span>
<span class="token comment"># 接受2个参数，如果第1个参数等于第2个参数，则返回NULL，否则返回第1个参数</span>
<span class="token keyword">SELECT</span> <span class="token keyword">NULLIF</span><span class="token punctuation">(</span><span class="token string">'fx67ll'</span><span class="token punctuation">,</span> <span class="token string">'fx67ll'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># NULL</span>
<span class="token keyword">SELECT</span> <span class="token keyword">NULLIF</span><span class="token punctuation">(</span><span class="token string">'fx67ll'</span><span class="token punctuation">,</span> <span class="token string">'ll76xf'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># fx67ll</span>

<span class="token comment"># NULLIF类似于下面的CASE表达式</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> expression_1 <span class="token operator">=</span> expression_2
   <span class="token keyword">THEN</span> <span class="token boolean">NULL</span>
<span class="token keyword">ELSE</span>
   expression_1
<span class="token keyword">END</span><span class="token punctuation">;</span>

<span class="token comment"># CASE判断：second</span>
<span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token number">2</span>
    <span class="token keyword">WHEN</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'first'</span>
    <span class="token keyword">WHEN</span> <span class="token number">2</span> <span class="token keyword">THEN</span> <span class="token string">'second'</span>
    <span class="token keyword">WHEN</span> <span class="token number">3</span> <span class="token keyword">THEN</span> <span class="token string">'third'</span>
    <span class="token keyword">ELSE</span> <span class="token string">'other'</span>
    <span class="token keyword">END</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div></li></ol> <h2 id="七、执行流程"><a href="#七、执行流程" class="header-anchor">#</a> 七、执行流程</h2> <p><kbd>客户端</kbd> -&gt; <kbd>处理连接</kbd> -&gt; <kbd><s>查询缓存</s></kbd> -&gt; <kbd>语法解析</kbd> -&gt; <kbd>优化器</kbd> -&gt; <kbd>执行器</kbd> -&gt; <kbd>存储引擎InnoDB</kbd> -&gt; <kbd>文件系统</kbd></p> <p>查询缓存 5.7 版本默认禁用，8.0版本直接删除了</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.ef321d21.js" defer></script><script src="/note/assets/js/2.4f793508.js" defer></script><script src="/note/assets/js/31.0d4a248a.js" defer></script>
  </body>
</html>
